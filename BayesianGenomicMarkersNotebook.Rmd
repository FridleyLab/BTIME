---
title: "Bayesian Analyses for mIF data for TIME (tumor inmune microenvironment)"
author: "Jose Laborde"
date: "`r format(Sys.time(), '%A %B %d, %Y')`"
# output:
# output:
#   rmdformats::downcute:
#     self_contained: true
#     thumbnails: true
#     lightbox: true
#     gallery: false
#     highlight: tango
    # downcute_theme: "chaos"
  # tufte::tufte_handout: default
  # tufte::tufte_html: default
  # toc: true
  # toc_float:
  # collapsed: false
  # smooth_scroll: false
output:
    html_document:
      toc: true
      toc_depth: 3
      toc_float: true
      df_print: paged
      theme: lumen
      number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objective

To develop Bayesian models and software for the analysis of mIF data and determination of immune subtypes while accounting for the zero-inflated nature of the immune count data. mIF data often contain many samples in which no cells are positive for a given immune marker (i.e., many zero counts).  Further, TMAs/tissue sections usually contain multiple cores/regions of interest (ROIs) that are correlated with one another as well as different immune cell types that co-localize. Here, we will develop a Bayesian zero-inflated beta-binomial model and an integrated Bayesian clustering approach to determine immune subtypes that leverage both the abundance and the spatial contexture of immune cells while also incorporating the relationship between markers and multiple measurements from a single tumor sample. 
We developed a Bayesian analysis of multiplex immunofluorescence data with 8 different models with various levels of zero-inflation or over-dispersion modeled:

- `fit1`: Binomial (B)
- `fit2`: Poisson (P)
- `fit3`: Negative Binomial (NB)
- `fit4`: Zero Inflated Binomial (ZIB)
- `fit5`: Zero Inflated Poisson (ZIP)
- `fit6`: Zero Inflated Negative Binomial (ZINB)
- `fit7`: Beta-Binomial (BB)
- `fit8`: Zero Inflated Beta-Binomial (ZIBB which is still pending for now)

# Data
We will be using the `Peres IF_AACES_NCOCS full data 12092020.rds` data file which I have and pre-processed stored locally.  This dataset originally lives in the shared folder `smb://hlm/data/lab/Lab_Fridley/bayesTIME/results/`.  Each model above has been ran using [`brms`](https://paul-buerkner.github.io/brms/ "Paul Buerkner's GitHub page").  Here is a small example of how that (larger) dataset looks like:

```{r datablock, message=FALSE}
dfmif = readRDS("Sample_mIF_data.rds")
head(dfmif,10)
```

The Bayesian models ran above have been stored on the files:

- `BRMS_models_foxp3_opal_540_positive_cells.RData`
- `BRMS_models_cd3_opal_650_positive_cells.RData`
- `BRMS_models_cd8_opal_570_positive_cells.RData`
- `BRMS_models_cd11b_opal_620_positive_cells.RData`
- `BRMS_models_cd15_opal_520_positive_cells.RData`
- `BRMS_models_cd3plus_foxp3plus_cells.RData`
- `BRMS_models_cd3plus_cd8plus_cells.RData`
- `BRMS_models_cd11bplus_cd15plus_cells.RData`

# Necessary Packages:
- `rstan`: For Hamiltonian MC (will install `Rcpp` and related libraries) https://mc-stan.org/users/interfaces/rstan
- `brms`: To build Bayesian GLMMs using `rstan` as a back end (will install `rstan` but I strongly recommend you install it in advance since it is not a trivial installation)
- `bayestestR` https://easystats.github.io/bayestestR/index.html to evaluate inferences.
- `bayesplot` https://mc-stan.org/users/interfaces/bayesplot to generate plots of inference results.
- `dplyr` for data manipulation.
- `kableExtra` for table manipulation and presentation.
- `ggplot2` for plotting.

```{r libraries, message=FALSE}
library(brms)
library(bayestestR)
library(bayesplot)
library(dplyr)
library(kableExtra)
library(ggplot2)
```

# Results for `cd11bplus_cd15plus_cells`
The contents of the `BRMS_models_cd11bplus_cd15plus_cells.RData` file are:

```{r foxp3-models, message=FALSE}
load("BRMS_models_cd11bplus_cd15plus_cells.RData")
my_vars = as.data.frame(eapply(.GlobalEnv,typeof))
head(my_vars)
```

## `fit1`: Binomial (B)

```{r assign-fit, message=FALSE}
fit = fit1
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results1, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```


<!-- start -->
## `fit2`: Poisson (P)

```{r assign-fit2, message=FALSE}
fit = fit2
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors2, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table2, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior2, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots2, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results2, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```

<!-- end -->

<!-- start -->
## `fit3`: Negative Binomial (NB)

```{r assign-fit3, message=FALSE}
fit = fit3
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors3, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table3, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior3, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots3, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results3, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```

<!-- end -->

<!-- start -->
## `fit4`: Zero Inflated Binomial (ZIB)

```{r assign-fit4, message=FALSE}
fit = fit4
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors4, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table4, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior4, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots4, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results4, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```

<!-- end -->

<!-- start -->
## `fit5`: Zero Inflated Poisson (ZIP)

```{r assign-fit5, message=FALSE}
fit = fit5
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors5, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table5, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior5, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots5, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results5, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```

<!-- end -->

<!-- start -->
## `fit6`: Zero Inflated Negative Binomial (ZINB)

```{r assign-fit6, message=FALSE}
fit = fit6
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors6, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table6, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior6, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots6, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results6, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```

<!-- end -->

<!-- start -->
## `fit7`: Beta-Binomial (BB)

```{r assign-fit7, message=FALSE}
fit = fit7
```

### Priors

Can look into some basic information on the prior distributions used.
```{r bayes-priors7, echo=TRUE}
prior_summary(fit)
```

### Summary of results for "Fixed" effects (`stage` and `intercept`):
`brms` has it's own overloaded `summary` function. I will just make it a little bit more aesthetic:
```{r Blm-Table7, results="asis", echo=TRUE}
bs = summary(fit)
bs = as.data.frame(bs[["fixed"]])
kable(bs, 'html', booktabs = TRUE, linesep = '', caption = 'Bayesian Regression Model Results for the Intercept and Stage with 95% Credible Intervals')%>%
  kable_styling(font_size = 15.0)
```

### Detailed Results for all estimated parameters:
```{r bayes-posterior7, results="asis", echo=TRUE}
describe_posterior(
  fit,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance", "rope"),
  centrality = "all"
)
```
- So what is the ROPE? check this: https://easystats.github.io/bayestestR/articles/region_of_practical_equivalence.html
- In essence, it is a null region (an interval around zero) tested against the parameter's estimated distribution.  If they overlap more than just a little bit, then you accept the Null.  Yes.  Accept.
- For linear models (lm), the ROPE is:
$$[−0.1∗SD_y, 0.1∗SD_y]$$

```{r rope-plots7, echo=TRUE}
# Compute indices
pd = p_direction(fit)
percentage_in_rope = rope(fit, ci=1)
# ci: The Credible Interval (CI) probability, corresponding to the proportion of HDI, to use for the percentage in ROPE.
# HDI: Highest Density Interval

# Visualize the pd (Probability of Direction)
plot(pd)

# Visualize the percentage in ROPE
plot(percentage_in_rope)
```

### Posterior Intervals with `bayesplot`

```{r view-results7, echo=TRUE}
bayesModel_posterior = as.matrix(fit)
color_scheme_set("purple")
plot_title = ggtitle("Posterior Intervals",
                     "with medians and 80% area")
mcmc_areas(bayesModel_posterior,
           pars = colnames(bayesModel_posterior)[1:3],
           prob = 0.80) + plot_title 
```

<!-- end -->

