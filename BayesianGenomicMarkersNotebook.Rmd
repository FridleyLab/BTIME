---
title: "Bayesian Analyses for mIF data for TIME (tumor inmune microenvironment)"
author: "Jose Laborde"
date: "`r format(Sys.time(), '%A %B %d, %Y')`"
# output:
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
    # downcute_theme: "chaos"
  # tufte::tufte_handout: default
  # tufte::tufte_html: default
  # toc: true
  # toc_float:
  # collapsed: false
  # smooth_scroll: false
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objective: 

To develop Bayesian models and software for the analysis of mIF data and determination of immune subtypes while accounting for the zero-inflated nature of the immune count data. mIF data often contain many samples in which no cells are positive for a given immune marker (i.e., many zero counts).  Further, TMAs/tissue sections usually contain multiple cores/regions of interest (ROIs) that are correlated with one another as well as different immune cell types that co-localize. Here, we will develop a Bayesian zero-inflated beta-binomial model and an integrated Bayesian clustering approach to determine immune subtypes that leverage both the abundance and the spatial contexture of immune cells while also incorporating the relationship between markers and multiple measurements from a single tumor sample. 

## Data
Preprocess the data:  I will be using the `Peres IF_AACES_NCOCS full data 12092020.rds` data file which I have stored locally.  This dataset originally lives in the shared folder `smb://hlm/data/lab/Lab_Fridley/bayesTIME/results/`.

```{r datablock}
# The following code is presented for explanation purposes but has been previously executed.  The result is the "dfmif" data frame
# Read the data in:
dfmif = readRDS("~/Documents/MyProjects/BayesianWorld/TestStan_files/Peres IF_AACES_NCOCS full data 12092020.rds")
# Subset the data by intratumoral_i_vs_peripheral_p_ == intratumoral only:
dfmif = subset(dfmif, intratumoral_i_vs_peripheral_p_ == "Intratumoral")
# process stage variable (this is X = group in my model)
# remove missing values
rmlist = which(is.na(dfmif$stage))
dfmif = dfmif[-rmlist,]
# now do this as per Brooke/Chris: 1 = Localized, 2 = Regional, and 3 = Distant. Group 1&2 vs 3:
dfmif$stage_group = as.factor(ifelse(dfmif$stage == "Distant", "Stage 3", "Stage 1 or 2"))
library(dplyr)
library(kableExtra)
dt = dfmif[c("suid", "stage_group", "total_cells",
        "foxp3_opal_540_positive_cells",
        "cd3_opal_650_positive_cells",
        "cd8_opal_570_positive_cells",
        "cd11b_opal_620_positive_cells",
        "cd15_opal_520_positive_cells",
        "cd3plus_foxp3plus_cells",
        "cd3plus_cd8plus_cells",
        "cd11bplus_cd15plus_cells")] %>% head(10)
kbl(dt) %>%
  kable_material(c("striped", "hover"),full_width = F)%>%
  kable_styling(fixed_thead = T)

```

# General model setup

Let $Y_{gjk}^{(i)}$ represent the number of positive cells for the marker $i$ where $i \in$: 

 - `foxp3_opal_540_positive_cells`
 - `cd3_opal_650_positive_cells`
 - `cd8_opal_570_positive_cells`
 - `cd11b_opal_620_positive_cells`
 - `cd15_opal_520_positive_cells`
 - `cd3plus_foxp3plus_cells`
 - `cd3plus_cd8plus_cells`
 - `cd11bplus_cd15plus_cells`
 
out of a total of $N_{gjk}$ cells measured in sample $k$ from subject $j$ in group $g$. Let the probability of positivity for marker $i$ be represented by $p_{ig}$. 

For simplicity let's omit the $i, k, \text{ and } g$ since it will become obvious soon.  

## Fit 1: Binomial model
A BB model would be:  
$$Y_{gjk}^{(i)} \sim Bin(p_{jg}^{(i)},N_{gjk})$$ 
with 
$$p_{jg}^{(i)} \sim Beta \left( \gamma^{(i)}\pi_g^{(i)},\gamma^{(i)}(1-\pi_g^{(i)}) \right)$$


I will use the data simulation case as described in [BRMS](https://github.com/paul-buerkner/brms)

I will conduct the analysis as in [`brms customfamilies`](https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html) 

Call in the necessary libraries first:

```{r libraries, message=FALSE}
library(bayestestR)
library(brms)
library(kableExtra)
```



# Graphical Model

```{r mydag, message=FALSE}
library(dagitty)
library(ggdag)
dag = dagify(y ~ p + s + g, p ~  f + t )
ggdag(dag)
```

# Bayesian hierarchical models for studying the TIME: 

In this part of Aim 2, we will develop Bayesian hierarchical models that model the over-dispersed and/or zero-inflated nature of mIF data109-114. In preliminary analysis of the markers measured in the AACES, we found that in general, the beta-binomial (BB) model fit the majority of immune cell markers best, out of the following possible models: binomial, BB, zero-inflated (ZI) binomial (ZIB), and ZI-beta binomial (ZIBB) (Fig 12). Based on this preliminary data, the Bayesian hierarchical model will be first developed assuming a BB model for all markers and then extended to allow for a ZIBB for extremely rare cell types (exploratory). The hierarchical model has three levels: (1) BB model for over-dispersion; (2) modeling m markers simultaneously; and (3) random effect for modeling multiple samples per individual. 


```{r step1, message=FALSE, warning=FALSE, eval = FALSE}
# The following code is presented fro explanation purposes but has been previously executed.
# The results are stored in the BRMS_models_cd11bplus_cd15plus_cells.RData object
library(brms)
# Models for cd11bplus_cd15plus_cells:
# fit1 = Binomial
start_time = Sys.time()
fit1 = brm(cd11bplus_cd15plus_cells | trials(total_cells) ~ stage_group + (1|suid),
           data = dfmif,
           family = binomial(), cores = 8,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit1)
time_fit1 = my_time
# fit2 = Poisson
start_time = Sys.time()
fit2 = brm(cd11bplus_cd15plus_cells ~ stage_group + (1|suid),
           data = dfmif,
           family = poisson(), cores = 8,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit2)
time_fit2 = my_time
# fit3 = Negative Binomial
start_time = Sys.time()
fit3 = brm(cd11bplus_cd15plus_cells ~ stage_group + (1|suid),
           data = dfmif,
           family = negbinomial(), cores = 8,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit3)
time_fit3 = my_time
# fit4 = zero_inflated_binomial
start_time = Sys.time()
fit4 = brm(cd11bplus_cd15plus_cells | trials(total_cells) ~ stage_group + (1|suid),
           data = dfmif,
           family = zero_inflated_binomial, cores = 8,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit4)
time_fit4 = my_time
# fit5 = zero_inflated_poisson
start_time = Sys.time()
fit5 = brm(cd11bplus_cd15plus_cells ~ stage_group + (1|suid),
           data = dfmif,
           family = zero_inflated_poisson(), cores = 8,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit5)
time_fit5 = my_time
# fit6 = zero_inflated_negbinomial
start_time = Sys.time()
fit6 = brm(cd11bplus_cd15plus_cells ~ stage_group + (1|suid),
           data = dfmif,
           family = zero_inflated_negbinomial(), cores = 8,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit6)
time_fit6 = my_time
# fit7 = beta_binomial2
start_time = Sys.time()
fit7 = brm(cd11bplus_cd15plus_cells | trials(total_cells) ~ stage_group + (1|suid),
           data = dfmif,
           family = beta_binomial2, cores = 8,
           stanvars = stanvars,
           iter = 14000,
           warmup = 4000)
end_time = Sys.time()
my_time = (end_time - start_time)
print(my_time)
summary(fit7)
time_fit7 = my_time
# Show total running time:
sum(time_fit1,time_fit2,time_fit3,time_fit4,time_fit5,time_fit6,time_fit7)
# Clean up variables before saving the models and necessary extra info:
remove(list=c("dfmif", "start_time", "end_time", "rmlist", "my_time", "dfvars"))
# Save the image corresponding to the models ran above using the markers names above:
save.image("~/Documents/MyProjects/BayesianWorld/TestStan_files/BRMS_models_cd11bplus_cd15plus_cells.RData")
```

Let $Y_{gjk}^{(i)}$ represent the number of positive cells for marker $i$ out of a total of $N_{gjk}$ cells measured in sample $k$ from subject $j$ in group $g$. Let the probability of positivity for marker $i$ be represented by $p_{ig}$. A BB model would be:  
$$Y_{gjk}^{(i)} \sim Bin(p_{jg}^{(i)},N_{gjk})$$ 
with 
$$p_{jg}^{(i)} \sim Beta \left( \gamma^{(i)}\pi_g^{(i)},\gamma^{(i)}(1-\pi_g^{(i)}) \right)$$
To model the binary predictor for subject $j$ in group $g$ (i.e.,  $X_{gj} =  1$ if group 1 and $X_{gj} =  0$ if group 2 on $Y_{gjk}^{(i)}$ the model would be 
$$logit(\pi_g^{(i)}) = \beta_0^{(i)} + \beta_1^{(i)} (X_{gj}) + S_{1gj}^{(i)}$$
To account for repeated measures (i.e., multiple TMA cores per subject), random subject effects, $S_{1gj}^{(i)}$, will also be included. For prior distribution for $\gamma^{(i)}$  we will use 
$$h\left(\gamma^{(i)}\right) ∝ 1⁄γ^{(i)} $$
and
$$ \beta^{(i)} = 
\begin{bmatrix}
\beta_0^{(i)}\\
\beta_1^{(i)}
\end{bmatrix} 
\sim MVN\left(
\begin{bmatrix}
\nu_0^{(i)}\\
\nu_1^{(i)}
\end{bmatrix},
\begin{bmatrix}
\tau_0^{(i)} & 0 \\
0 & \tau_1^{(i)} 
\end{bmatrix}
\right) $$

To model the dependency between the $m$ immune markers, we will then assume $\nu_1^T = \left(\nu_1^{(1)},\dots,\nu_1^{(m)} \right)$ follows a $MVN$ distribution with use of an unstructured or structured covariance matrix (i.e., T vs. B cells) to model relationships between different immune cell types. In the case of a ZIBB model, we would have a model 
$$\psi_g^{(i)} I_{\{Y_{gjk}^{(i)}=0 \}}+\left(1-\psi_g^{(i)}\right)f\left(p_{jg}^{(i)}|\gamma^{(i)},\pi_g^{(i)},Y_{gjk}^{(i)},N_{gjk}\right) $$
where $\psi_g^{(i)}$ is the zero probability model. The predictor model would include a predictor on the zero-model as

$$logit \left(\psi_g^{(i)}\right)=\lambda_0^{(i)} + \lambda_1^{(i)} (X_{gj} )+S_{2gj}^{(i)}$$
